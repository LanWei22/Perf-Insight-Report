<!DOCTYPE HTML>
<link rel="import" href="/perf_insights/ui/reports/pi_report.html">
<link rel="import" href="/tracing/ui/units/histogram_span.html">
<link rel="import" href="/tracing/ui/base/pie_chart.html">

<polymer-element name="pi-ui-r-my-two-input-event-report"
    extends="pi-ui-r-pi-report"
    map-function-href="/perf_insights/mappers/two_map_functions.html"
    map-function-name="mergeTwoMapsFunction">
  <template>
    <pre><span id="data"></span></pre>
	<tr-ui-b-table id="handling_start_table"></tr-ui-b-table>
	<tr-ui-b-table id="handling_move_table"></tr-ui-b-table>
	<tr-ui-b-table id="handling_start_v8_table"></tr-ui-b-table>
	<tr-ui-b-table id="handling_move_v8_table"></tr-ui-b-table>
	<tr-ui-b-table id="queuing_move_table"></tr-ui-b-table>
	<tr-ui-b-table id="queuing_move_v8_table"></tr-ui-b-table>
	<div id="chart" style="height:625px;width:1625px;"></div>
  </template>
  <script>
  'use strict';
  
  function createColumns(msg) {
    var columns = [
    {
      title: msg + ' Event\'s Title',
      value: function(row) {
        return row.title;
      },
      textAlign: 'left',
      width: '400px'
    },
    {
      title: msg + 'Event\'s SelfTime',
      value: function(row) {
        return row.count;
      },
      cmp: function(a, b) {
        return tr.b.compareNumericWithNaNs(a.count, b.count);
      },
      textAlign: 'left',
      width: '100px'
    }
    ];
    return columns;
  }

  function drawTable(allEvents, table, count, msg) {
    var columns = createColumns(msg);
    table.tableColumns = columns;
    table.sortColumnIndex = 1;
    table.sortDescending = true;
	
	var eventRows = [];
    for (var event in allEvents) {
		//if (allEvents[event] > 0) {
	        eventRows.push({
	          title: event,
	          count: allEvents[event]/count
	        });	
			//}       
    }
    table.tableRows = eventRows;
    table.rebuild();

  }
  
  function getLongestHandlingTimes(results, percent) {
	var handlingStartTimes = [];
	var handlingMoveTimes = [];
	results.forEach(function(result) {
	  if (result.pairs.handling_self_time != null) {
  	    handlingStartTimes = handlingStartTimes.concat(result.pairs.handling_self_time.touchStartHandlings);
  	    handlingMoveTimes = handlingMoveTimes.concat(result.pairs.handling_self_time.touchMoveHandlings);
	  }
	    
	});
	
	handlingStartTimes.sort(function(a, b) {return a.duration-b.duration});
	var longestTouchStarts = handlingStartTimes.slice(0, Math.ceil(handlingStartTimes.length/percent));
	handlingMoveTimes.sort(function(a, b) {return a.duration-b.duration});
	var longestTouchMoves = handlingMoveTimes.slice(0, Math.ceil(handlingMoveTimes.length/percent));
	var startHandlers = {};
	var moveHandlers = {};
	var v8ExcuteStart = [];
	var v8ExcuteMove = [];
	
	for (var i = 0; i < longestTouchStarts.length; i++) {
		for (var key in longestTouchStarts[i].selfTime) {
			if (key in startHandlers) {
			  startHandlers[key] += longestTouchStarts[i].selfTime[key];
			} else {
			  startHandlers[key] = longestTouchStarts[i].selfTime[key];
			}
			if (key.indexOf('V8.Execute') > -1)
				v8ExcuteStart.push(longestTouchStarts[i].selfTime[key]);
		}
		
	}
	for (var i = 0; i < longestTouchMoves.length; i++) {
		for (var key in longestTouchMoves[i].selfTime) {
			if (key in moveHandlers) {
			  moveHandlers[key] += longestTouchMoves[i].selfTime[key];
			} else {
			  moveHandlers[key] = longestTouchMoves[i].selfTime[key];
			}
			if (key.indexOf('V8.Execute') > -1)
				v8ExcuteMove.push(longestTouchMoves[i].selfTime[key]);
		}
		
	}
	
    var value = {
	  startCount: longestTouchStarts.length,
	  moveCount: longestTouchMoves.length,
	  startHandlers: startHandlers,
      moveHandlers: moveHandlers,
	  v8ExcuteStart: v8ExcuteStart,
	  v8ExcuteMove: v8ExcuteMove	
    };
    return value;
  }
  
  
  function getLongestQueuingtTimes(results, percent) {
	var queuingMoveTimes = [];
	results.forEach(function(result) {
	  if (result.pairs.queuing_self_time != null)
	    queuingMoveTimes = queuingMoveTimes.concat(result.pairs.queuing_self_time);
	});
	
	queuingMoveTimes.sort(function(a, b) {return a.duration-b.duration});
	var longestQueuing = queuingMoveTimes.slice(0, Math.ceil(queuingMoveTimes.length/percent));
	var moveHandlers = {};
	var v8ExcuteMove = [];
	
	for (var i = 0; i < longestQueuing.length; i++) {
		for (var key in longestQueuing[i].selfTime) {
			if (key in moveHandlers) {
			  moveHandlers[key] += longestQueuing[i].selfTime[key];
			} else {
			  moveHandlers[key] = longestQueuing[i].selfTime[key];
			}
			if (key.indexOf('V8.Execute') > -1)
				v8ExcuteMove.push(longestQueuing[i].selfTime[key]);
		}
		
	}
	
    var value = {
	  count: longestQueuing.length,
	  moveHandlers: moveHandlers,
	  v8ExcuteMove: v8ExcuteMove
    };
    return value;
  }
  
    Polymer({
    created: function() {
      this.mapResults_ = undefined;
    },
    get mapResults() {
      return this.mapResults_;
    },
    set mapResults(mapResults) {
      this.mapResults_ = mapResults;
      this.updateContents_();
    },

	updateContents_: function() {
		  // this.$.data.textContent = JSON.stringify(this.mapResults_, null, 't');
	      var handling_start_table = this.$.handling_start_table;
		  var handling_move_table = this.$.handling_move_table;
	      var handling_start_v8_table = this.$.handling_start_v8_table;
		  var handling_move_v8_table = this.$.handling_move_v8_table;
		  var queuing_move_table = this.$.queuing_move_table;
		  var queuing_move_v8_table = this.$.queuing_move_v8_table;
		  
		  var percent = 10;
	      var handlingValue = getLongestHandlingTimes(this.mapResults_, percent);
		  var queuingValue = getLongestQueuingtTimes(this.mapResults_, percent);
					  
		  drawTable(handlingValue.startHandlers, handling_start_table, handlingValue.startCount, 'Handlering touch start');
		  drawTable(handlingValue.moveHandlers, handling_move_table, handlingValue.moveCount, 'Handlering touch move');
		  drawTable(handlingValue.v8ExcuteStart, handling_start_v8_table, 1, 'V8Excute in touch start');
		  drawTable(handlingValue.v8ExcuteMove, handling_move_v8_table, 1, 'V8Excute in touch move');
		  
		  drawTable(queuingValue.moveHandlers, queuing_move_table, queuingValue.count, 'Queuing touch move');
		  drawTable(queuingValue.v8ExcuteMove, queuing_move_v8_table, 1, 'V8Excute in touch move');
		  
		  
		  // var chart = new tr.ui.b.PieChart();
// 	      chart.width = 1000;
//  	      chart.height = 400;
// 		  chart.chartTitle = 'Events\' self-time';
// 	      var data = [];
//
// 		  for (var event in allEvents) {
// 	        data.push({
// 	          label: event,
// 	          value: allEvents[event]/count
// 	        });
// 	      }
//
// 	      chart.data = data;
// 		  this.$.chart.appendChild(chart);
 
    }, 
	
		  
		  
	
  });
  
  
  </script>
</polymer-element>
